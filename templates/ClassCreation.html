<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Add Students to Class</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <style>
    /* --- –°–±—Ä–æ—Å –±–∞–∑–æ–≤—ã—Ö —Å—Ç–∏–ª–µ–π –∏ box-sizing --- */
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      overflow-x: hidden;
      box-sizing: border-box;
    }
    *, *::before, *::after {
      box-sizing: inherit;
    }

    .student-select-form label {
      margin-top: 10px;
      display: block;
      color: var(--nav-text);
    }
    .student-select-form input[type="text"] {
      width: 100%;
      margin-bottom: 10px;
      background-color: var(--input-bg);
      color: var(--text-color);
      border: 1px solid var(--input-border);
      border-radius: 4px;
      padding: 8px;
    }
    .student-select-form button[type="submit"],
    .student-select-form button[type="button"].add-btn {
      width: 100%;
      margin-top: 15px;
      padding: 10px;
      background-color: var(--accent-color);
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    .student-select-form button[type="submit"]:hover,
    .student-select-form button[type="button"].add-btn:hover {
      background-color: var(--accent-hover);
    }

    /* --- –°–ø–∏—Å–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ --- */
    .added-student-list .added-student {
      margin-top: 5px;
      background: var(--card-bg);
      padding: 5px 10px;
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: var(--text-color);
      position: relative;
    }
    .added-student-list .added-student .student-name {
      /* –µ—Å–ª–∏ –Ω—É–∂–Ω–æ, –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–µ–∑–∫—É –∏–ª–∏ –ø–µ—Ä–µ–Ω–æ—Å */
      word-break: break-word;
    }
    .added-student-list .added-student .remove-btn {
      background: none;
      border: none;
      padding: 0;
      margin: 0;
      font-size: 1.2em;      /* —Ä–∞–∑–º–µ—Ä –∫—Ä–µ—Å—Ç–∏–∫–∞; –ø–æ–¥–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–π—Ç–µ –ø–æ –≤–∫—É—Å—É */
      line-height: 1;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: var(--accent-color);
    }
    .added-student-list .added-student .remove-btn:hover {
      color: #c00;
    }
    .added-student-list .added-student .remove-btn:focus {
      outline: 1px dotted #444;
      outline-offset: 2px;
    }

    /* --- –°—Ç–∏–ª–∏ –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è --- */
    .input-wrapper {
      position: relative;
      width: 100%;
    }
    .input-wrapper input {
      width: 100%;
      padding-right: 2rem; /* —Ä–µ–∑–µ—Ä–≤ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –æ—á–∏—Å—Ç–∫–∏ */
    }
    .clear-btn {
      position: absolute;
      right: 8px;               /* —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç –ø—Ä–∞–≤–æ–≥–æ –∫—Ä–∞—è wrapper */
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      font-size: 1.2rem;
      cursor: pointer;
      display: none;            /* –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è, –∫–æ–≥–¥–∞ –µ—Å—Ç—å —Ç–µ–∫—Å—Ç */
      color: var(--accent-color);
      padding: 0;
      line-height: 1;
    }
    .clear-btn:hover {
      color: var(--accent-hover-text, #000);
    }
    .autocomplete-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      max-height: 150px;
      overflow-y: auto;
      background-color: #f75200; /* –∏–ª–∏ var(--...) */
      border: 1px solid #cccccc;
      border-top: none;
      border-radius: 0 0 4px 4px;
      box-shadow: 0 4px 8px rgba(164, 89, 4, 0.4);
      z-index: 1000;
      list-style: none;
      margin: 0;
      padding: 0;
    }
    .autocomplete-list li {
      padding: 8px 12px;
      cursor: pointer;
      color: #010000;
    }
    .autocomplete-list li:hover {
      background-color: #e70000;
      color: #fff;
    }
  </style>
</head>
<body>
  <!-- NAVBAR -->
  <header class="navbar">
    <div class="left-section">
      {% if loged == None %}
        <a href="/" class="logo">HomeNote</a>
      {% else %}
        <a href="/profile" class="logo">HomeNote</a>
      {% endif %}
      <a href="{{ url_for('index') }}" class="about-btn">About us</a>
    </div>
    <nav class="nav-links">
      {% if loged == None %}
        <button class="login-btn" onclick="location.href='login'">Login/Sign up</button>
      {% endif %}
      {% if loged == "student" %}
        <a href="/info">My homework</a>
        <a href="/settings">‚öôÔ∏è</a>
      {% endif %}
      {% if loged == "teacher" %}
        <a href="/Classes">My classes</a>
        <a href="{{ url_for('create') }}">Create homework</a>
        <a href="/info">Existing homeworks</a>
        <button class="login-btn" onclick="location.href='profile'">Profile</button>
        <a onclick="location.href='profile'">‚öôÔ∏è</a>
      {% endif %}
      <!-- –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–µ–º—ã -->
      <button id="theme-toggle" class="theme-toggle-btn" title="Toggle theme">üåô</button>
    </nav>
  </header>

  <!-- MAIN -->
  <main>
    <section class="hero">
      <h1>Add Students to a Class</h1>
      <p>Create a new class or add students to an existing one.</p>
    </section>

    <!-- Form -->
    <section class="about">
      <div style="max-width: 400px; margin: 0 auto;">
        <form class="student-select-form" action="{{ url_for('CreateClass') }}" method="POST" novalidate>
          <label for="className">Class Name</label>
          <input type="text" id="className" name="class_name" placeholder="Enter class name" required>

          <label for="studentSearch">Search Student</label>
          <div class="input-wrapper">
            <input type="text" id="studentSearch" autocomplete="off" placeholder="Type to search">
            <!-- –ö–Ω–æ–ø–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –ø–æ–ª—è -->
            <button type="button" id="clearBtn" class="clear-btn" onclick="clearStudentSearch()" aria-label="Clear">&times;</button>
            <ul id="autocompleteList" class="autocomplete-list"></ul>
          </div>

          <input type="hidden" id="studentDropdown" name="USER">

          <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ–¥–Ω–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞ -->
          <button type="button" class="add-btn" onclick="addStudent()">Add Student</button>
          <!-- –°–ø–∏—Å–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ -->
          <div id="addedStudents" class="added-student-list"></div>
          <!-- –°–∫—Ä—ã—Ç—ã–µ –∏–Ω–ø—É—Ç—ã –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
          <div id="hiddenInputs"></div>

          <button type="submit">Create / Add to Class</button>
        </form>
      </div>
    </section>
  </main>

  <!-- FOOTER -->
  <footer>
    <p>&copy; <span id="year"></span> HomeNote. All rights reserved.</p>
    <p>
      <button type="button" style="background:none;border:none;color:var(--accent-color);cursor:pointer;">Privacy Policy</button>
      |
      <button type="button" style="background:none;border:none;color:var(--accent-color);cursor:pointer;">Terms of Service</button>
    </p>
  </footer>

  <!-- Data + Script -->
  <script type="application/json" id="students-data">{{ students | tojson }}</script>
  <script>
    (function () {
      // Theme toggle
      const toggleBtn = document.getElementById('theme-toggle');
      const root = document.documentElement;
      if (toggleBtn) {
        let theme = localStorage.getItem('theme');
        if (!theme) {
          theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }
        root.setAttribute('data-theme', theme);
        toggleBtn.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        toggleBtn.onclick = () => {
          theme = root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
          root.setAttribute('data-theme', theme);
          localStorage.setItem('theme', theme);
          toggleBtn.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        };
      }

      // –ü–∞—Ä—Å–∏–º –¥–∞–Ω–Ω—ã–µ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –∏–∑ JSON –≤ —Ç–µ–≥–µ
      let students = [];
      try {
        const raw = document.getElementById('students-data').textContent;
        students = JSON.parse(raw) || [];
      } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ students-data:", e);
      }

      // –°—Å—ã–ª–∫–∏ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç—ã
      const searchInput = document.getElementById('studentSearch');
      const hiddenInput = document.getElementById('studentDropdown');
      const list = document.getElementById('autocompleteList');
      const addedList = document.getElementById('addedStudents');
      const hiddenInputs = document.getElementById('hiddenInputs');
      const clearBtn = document.getElementById('clearBtn');

      if (searchInput) {
        // –ü–æ–∫–∞–∑/—Å–∫—Ä—ã—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ –æ—á–∏—Å—Ç–∫–∏
        searchInput.addEventListener('input', () => {
          if (clearBtn) {
            clearBtn.style.display = searchInput.value.trim() ? 'block' : 'none';
          }
        });

        // Debounce –¥–ª—è –≤–≤–æ–¥–∞
        function debounce(fn, delay = 200) {
          let timer = null;
          return function(...args) {
            clearTimeout(timer);
            timer = setTimeout(() => fn.apply(this, args), delay);
          };
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞: –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è
        const handleInput = () => {
          const q = searchInput.value.toLowerCase().trim();
          if (list) list.innerHTML = '';
          if (hiddenInput) hiddenInput.value = '';

          if (!q) return;

          const filtered = students.filter(s =>
            s.name && s.name.toLowerCase().includes(q)
          );
          if (filtered.length === 0) {
            return;
          }
          filtered.forEach(s => {
            const li = document.createElement('li');
            li.textContent = s.name;
            li.dataset.id = s.id;
            li.addEventListener('click', () => {
              searchInput.value = s.name;
              if (hiddenInput) hiddenInput.value = s.id;
              if (list) list.innerHTML = '';
              if (clearBtn) clearBtn.style.display = searchInput.value.trim() ? 'block' : 'none';
            });
            if (list) list.appendChild(li);
          });
        };
        searchInput.addEventListener('input', debounce(handleInput, 200));

        // Keydown: Enter/Tab –ø—Ä–∏ –æ–¥–Ω–æ–º –≤–∞—Ä–∏–∞–Ω—Ç–µ
        searchInput.addEventListener('keydown', (e) => {
          if (!list) return;
          const items = list.children;
          if ((e.key === 'Enter' || e.key === 'Tab') && items.length === 1) {
            e.preventDefault();
            const li = items[0];
            searchInput.value = li.textContent;
            if (hiddenInput) hiddenInput.value = li.dataset.id;
            list.innerHTML = '';
            if (clearBtn) clearBtn.style.display = searchInput.value.trim() ? 'block' : 'none';
          }
        });

        // –°–∫—Ä—ã—Ç—å —Å–ø–∏—Å–æ–∫ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
        document.addEventListener('click', e => {
          if (searchInput && list && !searchInput.contains(e.target) && !list.contains(e.target) && e.target !== clearBtn) {
            list.innerHTML = '';
          }
        });
      }

      // –§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ –ø–æ–ª—è –ø–æ–∏—Å–∫–∞
      window.clearStudentSearch = function () {
        if (searchInput) searchInput.value = '';
        if (hiddenInput) hiddenInput.value = '';
        if (list) list.innerHTML = '';
        if (clearBtn) clearBtn.style.display = 'none';
        if (searchInput) searchInput.focus();
      };

      // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—É–¥–µ–Ω—Ç–∞
      window.addStudent = function () {
        if (!searchInput || !hiddenInput || !addedList || !hiddenInputs) return;
        const id = hiddenInput.value;
        const name = searchInput.value.trim();
        if (!id || !name) {
          alert('Please select a student from the list.');
          return;
        }
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–∞–∫–æ–≥–æ id –µ—â—ë –Ω–µ—Ç –≤ —Å–ø–∏—Å–∫–µ
        if ([...addedList.children].some(div => div.dataset.id === id)) {
          alert('Student already added.');
          return;
        }
        // –°–æ–∑–¥–∞—ë–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞
        const div = document.createElement('div');
        div.className = 'added-student';
        div.dataset.id = id;
        // –£–ø—Ä–æ—â—ë–Ω–Ω–∞—è —Ä–∞–∑–º–µ—Ç–∫–∞: span + –∫–Ω–æ–ø–∫–∞
        div.innerHTML = `
          <span class="student-name">${name}</span>
          <button type="button" class="remove-btn" onclick="removeStudent(this,'${id}')" aria-label="Remove ${name}">&times;</button>
        `;
        addedList.appendChild(div);

        // –°–æ–∑–¥–∞—ë–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —Å–∫—Ä—ã—Ç—ã–π input –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'students[]';
        input.value = id;
        input.dataset.id = id;
        hiddenInputs.appendChild(input);

        // –û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
        clearStudentSearch();
      };

      // –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç—É–¥–µ–Ω—Ç–∞
      window.removeStudent = function (btn, id) {
        // –£–¥–∞–ª—è–µ–º –≤–Ω–µ—à–Ω–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä .added-student
        const entry = btn.closest('.added-student');
        if (entry) {
          entry.remove();
        }
        // –£–¥–∞–ª—è–µ–º —Å–∫—Ä—ã—Ç—ã–π input
        if (hiddenInputs) {
          const input = hiddenInputs.querySelector(`input[data-id="${id}"]`);
          if (input) input.remove();
        }
      };

      // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≥–æ–¥–∞ –≤ —Ñ—É—Ç–µ—Ä–µ
      const yearSpan = document.getElementById('year');
      if (yearSpan) {
        yearSpan.textContent = new Date().getFullYear();
      }
    })();
  </script>
</body>
</html>
